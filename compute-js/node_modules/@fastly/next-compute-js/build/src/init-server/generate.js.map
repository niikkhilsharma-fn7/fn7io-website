{"version":3,"file":"generate.js","sourceRoot":"","sources":["../../../src/init-server/generate.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n */\n\nimport child_process from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport nunjucks from 'nunjucks';\n\nconst COMPUTE_JS_DIR = './compute-js';\n\n// Directory structure looks weird, but /src gets compiled to /build/src,\n// so are one layer deeper\nconst RESOURCES_DIR = '../../../resources';\n\nexport function checkServerProject() {\n  const computeJsDir = path.resolve(COMPUTE_JS_DIR);\n  return fs.existsSync(computeJsDir);\n}\n\ntype CopyOptions = {\n  toFileName?: string,\n  templateContext?: object,\n};\n\nexport function copyResourceFile(filePath: string, src: string, target: string, opts?: CopyOptions) {\n  const srcFilePath = path.resolve(__dirname, RESOURCES_DIR, src, filePath);\n  let targetFilePath = path.resolve(target, filePath);\n  if(opts?.toFileName != null) {\n    targetFilePath = path.join(path.dirname(targetFilePath), opts.toFileName);\n  }\n  if(opts?.templateContext != null) {\n    console.log(srcFilePath + ' -> ' + targetFilePath + ' (template)');\n    const srcFile = fs.readFileSync(srcFilePath, 'utf-8');\n    const destFile = nunjucks.renderString(srcFile, opts.templateContext);\n    fs.writeFileSync(targetFilePath, destFile, 'utf-8');\n  } else {\n    console.log(srcFilePath + ' -> ' + targetFilePath);\n    fs.copyFileSync(srcFilePath, targetFilePath);\n  }\n}\n\nexport function generateServerProject() {\n\n  if(checkServerProject()) {\n    console.error(`‚ùå '${COMPUTE_JS_DIR}' directory already exists!`);\n    process.exit(1);\n  }\n\n  let packageJsonContent: string | null;\n  try {\n    const packageJsonPathname = path.resolve('./package.json');\n    packageJsonContent = fs.readFileSync(packageJsonPathname, 'utf-8');\n  } catch {\n    console.error('‚ùå package.json not found in current directory.');\n    process.exit(1);\n  }\n\n  let packageJson: any;\n  try {\n    packageJson = JSON.parse(packageJsonContent);\n  } catch {\n    console.error('‚ùå Unable to parse package.json in current directory.');\n    process.exit(1);\n  }\n\n  let name: string;\n  if(packageJson.name != null) {\n    name = packageJson.name + '-next-compute-js-app';\n  } else {\n    name = \"next-compute-js-app\";\n    console.warn(`package.json does not define a 'name'. Using default name: ${name}`);\n  }\n\n  const computeJsDir = path.resolve(COMPUTE_JS_DIR);\n  console.log(\"Initializing Compute Application in \" + computeJsDir + \"...\");\n  console.log(\"Application name: \" + name);\n  fs.mkdirSync(computeJsDir);\n  fs.mkdirSync(path.resolve(computeJsDir, './src'));\n\n  // Copy resource files\n  const files = [\n    'src/index.js',\n    ['_gitignore', '.gitignore'],\n    '.npmrc',\n    'default-content-types.cjs',\n    ['fastly.toml.njk', 'fastly.toml'],\n    ['package.json.njk', 'package.json'],\n    'static-publish.rc.js',\n    'webpack.config.js',\n  ];\n  for (const file of files) {\n    let fromFile: string;\n    let copyOpts: CopyOptions = {};\n    if(Array.isArray(file)) {\n      [fromFile, copyOpts.toFileName] = file;\n    } else {\n      fromFile = file;\n    }\n    if(fromFile.endsWith('.njk')) {\n      copyOpts.templateContext = {\n        appName: name,\n      };\n    }\n    copyResourceFile(fromFile, 'compute-js', computeJsDir, copyOpts);\n  }\n\n  console.log(\"üöÄ Compute application created!\");\n\n  console.log('Installing dependencies...');\n  console.log(`npm --prefix ${COMPUTE_JS_DIR} install`);\n  child_process.spawnSync('npm', [ '--prefix', COMPUTE_JS_DIR, 'install' ], { stdio: 'inherit' });\n  console.log('');\n\n  console.log('');\n  console.log('To run your Compute application locally:');\n  console.log('');\n  console.log('  cd ' + COMPUTE_JS_DIR);\n  console.log('  fastly compute serve');\n  console.log('');\n  console.log('To build and deploy to your Compute service:');\n  console.log('');\n  console.log('  cd ' + COMPUTE_JS_DIR);\n  console.log('  fastly compute publish');\n  console.log('');\n}\n"]}