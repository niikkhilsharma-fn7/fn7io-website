"use strict";
/*
 * Copyright Fastly, Inc.
 * Licensed under the MIT license. See LICENSE file for details.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateServerProject = exports.copyResourceFile = exports.checkServerProject = void 0;
const child_process_1 = __importDefault(require("child_process"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const nunjucks_1 = __importDefault(require("nunjucks"));
const COMPUTE_JS_DIR = './compute-js';
// Directory structure looks weird, but /src gets compiled to /build/src,
// so are one layer deeper
const RESOURCES_DIR = '../../../resources';
function checkServerProject() {
    const computeJsDir = path_1.default.resolve(COMPUTE_JS_DIR);
    return fs_1.default.existsSync(computeJsDir);
}
exports.checkServerProject = checkServerProject;
function copyResourceFile(filePath, src, target, opts) {
    const srcFilePath = path_1.default.resolve(__dirname, RESOURCES_DIR, src, filePath);
    let targetFilePath = path_1.default.resolve(target, filePath);
    if ((opts === null || opts === void 0 ? void 0 : opts.toFileName) != null) {
        targetFilePath = path_1.default.join(path_1.default.dirname(targetFilePath), opts.toFileName);
    }
    if ((opts === null || opts === void 0 ? void 0 : opts.templateContext) != null) {
        console.log(srcFilePath + ' -> ' + targetFilePath + ' (template)');
        const srcFile = fs_1.default.readFileSync(srcFilePath, 'utf-8');
        const destFile = nunjucks_1.default.renderString(srcFile, opts.templateContext);
        fs_1.default.writeFileSync(targetFilePath, destFile, 'utf-8');
    }
    else {
        console.log(srcFilePath + ' -> ' + targetFilePath);
        fs_1.default.copyFileSync(srcFilePath, targetFilePath);
    }
}
exports.copyResourceFile = copyResourceFile;
function generateServerProject() {
    if (checkServerProject()) {
        console.error(`‚ùå '${COMPUTE_JS_DIR}' directory already exists!`);
        process.exit(1);
    }
    let packageJsonContent;
    try {
        const packageJsonPathname = path_1.default.resolve('./package.json');
        packageJsonContent = fs_1.default.readFileSync(packageJsonPathname, 'utf-8');
    }
    catch (_a) {
        console.error('‚ùå package.json not found in current directory.');
        process.exit(1);
    }
    let packageJson;
    try {
        packageJson = JSON.parse(packageJsonContent);
    }
    catch (_b) {
        console.error('‚ùå Unable to parse package.json in current directory.');
        process.exit(1);
    }
    let name;
    if (packageJson.name != null) {
        name = packageJson.name + '-next-compute-js-app';
    }
    else {
        name = "next-compute-js-app";
        console.warn(`package.json does not define a 'name'. Using default name: ${name}`);
    }
    const computeJsDir = path_1.default.resolve(COMPUTE_JS_DIR);
    console.log("Initializing Compute Application in " + computeJsDir + "...");
    console.log("Application name: " + name);
    fs_1.default.mkdirSync(computeJsDir);
    fs_1.default.mkdirSync(path_1.default.resolve(computeJsDir, './src'));
    // Copy resource files
    const files = [
        'src/index.js',
        ['_gitignore', '.gitignore'],
        '.npmrc',
        'default-content-types.cjs',
        ['fastly.toml.njk', 'fastly.toml'],
        ['package.json.njk', 'package.json'],
        'static-publish.rc.js',
        'webpack.config.js',
    ];
    for (const file of files) {
        let fromFile;
        let copyOpts = {};
        if (Array.isArray(file)) {
            [fromFile, copyOpts.toFileName] = file;
        }
        else {
            fromFile = file;
        }
        if (fromFile.endsWith('.njk')) {
            copyOpts.templateContext = {
                appName: name,
            };
        }
        copyResourceFile(fromFile, 'compute-js', computeJsDir, copyOpts);
    }
    console.log("üöÄ Compute application created!");
    console.log('Installing dependencies...');
    console.log(`npm --prefix ${COMPUTE_JS_DIR} install`);
    child_process_1.default.spawnSync('npm', ['--prefix', COMPUTE_JS_DIR, 'install'], { stdio: 'inherit' });
    console.log('');
    console.log('');
    console.log('To run your Compute application locally:');
    console.log('');
    console.log('  cd ' + COMPUTE_JS_DIR);
    console.log('  fastly compute serve');
    console.log('');
    console.log('To build and deploy to your Compute service:');
    console.log('');
    console.log('  cd ' + COMPUTE_JS_DIR);
    console.log('  fastly compute publish');
    console.log('');
}
exports.generateServerProject = generateServerProject;
//# sourceMappingURL=generate.js.map