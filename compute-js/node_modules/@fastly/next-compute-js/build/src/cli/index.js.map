{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/cli/index.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n */\n\nimport arg from 'arg';\nimport fs from 'fs';\nimport path from 'path';\n\nconst defaultCommand = 'init';\nexport type cliCommand = (argv?: string[]) => void;\nexport const commands: { [command: string]: () => Promise<cliCommand> } = {\n  init: () => Promise.resolve(require('./commands/init').init),\n};\n\nfunction checkNextInstalled() {\n  // Check that we are in a directory with next\n  let packageJsonContent: string | null;\n  try {\n    const packageJsonPathname = path.resolve('./package.json');\n    packageJsonContent = fs.readFileSync(packageJsonPathname, 'utf-8');\n  } catch {\n    console.warn('package.json not found in current directory.');\n    return false;\n  }\n\n  let packageJson: any;\n  try {\n    packageJson = JSON.parse(packageJsonContent);\n  } catch {\n    console.warn('Unable to parse package.json in current directory.');\n    return false;\n  }\n\n  let isNextInstalled;\n  try {\n    isNextInstalled = Object.getOwnPropertyNames(packageJson.dependencies).includes('next');\n  } catch {\n    isNextInstalled = false;\n  }\n\n  if(!isNextInstalled) {\n    console.warn(`The module 'next' was not found.`);\n  }\n  return isNextInstalled;\n}\n\nexport function exec() {\n\n  const isNextInstalled = checkNextInstalled();\n  const args = arg(\n    {\n      // Types\n      '--version': Boolean,\n      '--help': Boolean,\n\n      // Aliases\n      '-v': '--version',\n      '-h': '--help',\n    },\n    {\n      permissive: true,\n    }\n  );\n\n  const foundCommand = Boolean(commands[args._[0]]);\n  if (!foundCommand && args['--help']) {\n    console.log(\n      `\n      Usage\n        $ next-compute-js <command>\n  \n      Available commands\n        ${Object.keys(commands).join(', ')}\n  \n      Options\n        --version, -v   Version number\n        --help, -h      Displays this message\n  \n      For more information run a command with the --help flag\n        $ next-compute-js build --help\n    `);\n    process.exit(0);\n  }\n\n  const command = foundCommand ? args._[0] : defaultCommand\n  const forwardedArgs = foundCommand ? args._.slice(1) : args._;\n\n  // Make sure the `next <subcommand> --help` case is covered\n  if (args['--help']) {\n    forwardedArgs.push('--help');\n  }\n\n  if(!isNextInstalled) {\n    console.error(\n      `@fastly/next-compute-js requires that 'next' be in 'dependencies' of your 'package.json'. To add it, run 'npm install next'.`\n    );\n    process.exit(1);\n  }\n\n  commands[command]()\n    .then((exec) => exec(forwardedArgs))\n    .then(() => {\n      if (command === 'build') {\n        // ensure process exits after build completes so open handles/connections\n        // don't cause process to hang\n        process.exit(0)\n      }\n    });\n}\n"]}