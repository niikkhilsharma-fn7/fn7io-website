"use strict";
/*
 * Copyright Fastly, Inc.
 * Licensed under the MIT license. See LICENSE file for details.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.exec = exports.commands = void 0;
const arg_1 = __importDefault(require("arg"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const defaultCommand = 'init';
exports.commands = {
    init: () => Promise.resolve(require('./commands/init').init),
};
function checkNextInstalled() {
    // Check that we are in a directory with next
    let packageJsonContent;
    try {
        const packageJsonPathname = path_1.default.resolve('./package.json');
        packageJsonContent = fs_1.default.readFileSync(packageJsonPathname, 'utf-8');
    }
    catch (_a) {
        console.warn('package.json not found in current directory.');
        return false;
    }
    let packageJson;
    try {
        packageJson = JSON.parse(packageJsonContent);
    }
    catch (_b) {
        console.warn('Unable to parse package.json in current directory.');
        return false;
    }
    let isNextInstalled;
    try {
        isNextInstalled = Object.getOwnPropertyNames(packageJson.dependencies).includes('next');
    }
    catch (_c) {
        isNextInstalled = false;
    }
    if (!isNextInstalled) {
        console.warn(`The module 'next' was not found.`);
    }
    return isNextInstalled;
}
function exec() {
    const isNextInstalled = checkNextInstalled();
    const args = (0, arg_1.default)({
        // Types
        '--version': Boolean,
        '--help': Boolean,
        // Aliases
        '-v': '--version',
        '-h': '--help',
    }, {
        permissive: true,
    });
    const foundCommand = Boolean(exports.commands[args._[0]]);
    if (!foundCommand && args['--help']) {
        console.log(`
      Usage
        $ next-compute-js <command>
  
      Available commands
        ${Object.keys(exports.commands).join(', ')}
  
      Options
        --version, -v   Version number
        --help, -h      Displays this message
  
      For more information run a command with the --help flag
        $ next-compute-js build --help
    `);
        process.exit(0);
    }
    const command = foundCommand ? args._[0] : defaultCommand;
    const forwardedArgs = foundCommand ? args._.slice(1) : args._;
    // Make sure the `next <subcommand> --help` case is covered
    if (args['--help']) {
        forwardedArgs.push('--help');
    }
    if (!isNextInstalled) {
        console.error(`@fastly/next-compute-js requires that 'next' be in 'dependencies' of your 'package.json'. To add it, run 'npm install next'.`);
        process.exit(1);
    }
    exports.commands[command]()
        .then((exec) => exec(forwardedArgs))
        .then(() => {
        if (command === 'build') {
            // ensure process exits after build completes so open handles/connections
            // don't cause process to hang
            process.exit(0);
        }
    });
}
exports.exec = exec;
//# sourceMappingURL=index.js.map