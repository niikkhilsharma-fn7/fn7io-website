{"version":3,"file":"require.js","sourceRoot":"","sources":["../../../src/server/require.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n *\n * Portions of this file Copyright Vercel, Inc., licensed under the MIT license. See LICENSE file for details.\n */\n\nimport { join, relative } from 'path';\n\nimport {\n  APP_PATHS_MANIFEST,\n  FONT_MANIFEST,\n  PAGES_MANIFEST,\n  SERVER_DIRECTORY,\n  SERVERLESS_DIRECTORY\n} from 'next/constants';\nimport { PagesManifest } from 'next/dist/build/webpack/plugins/pages-manifest-plugin';\nimport { normalizeLocalePath } from 'next/dist/shared/lib/i18n/normalize-locale-path';\nimport { denormalizePagePath } from 'next/dist/shared/lib/page-path/denormalize-page-path';\nimport { normalizePagePath } from 'next/dist/shared/lib/page-path/normalize-page-path';\nimport { MissingStaticPage, PageNotFoundError } from 'next/dist/shared/lib/utils';\n\nimport { Assets } from './common';\n\n/**\n * Finds the path that corresponds to a page, based on the pages manifest and localizations.\n * (An adaptation for Compute of function in Next.js of the same name,\n * found at next/server/require.ts)\n */\nexport function getPagePath(\n  assets: Assets,\n  page: string,\n  dir: string,\n  distDir: string,\n  serverless: boolean,\n  dev?: boolean,\n  locales?: string[],\n  appDirEnabled?: boolean\n): string {\n  const serverBuildPath = join(\n    distDir,\n    serverless && !dev ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n  );\n  let rootPathsManifest: undefined | PagesManifest;\n\n  if (appDirEnabled) {\n    rootPathsManifest = readAssetManifest(\n      assets,\n      join(serverBuildPath, APP_PATHS_MANIFEST),\n      dir\n    );\n  }\n  const pagesManifest = readAssetManifest(\n    assets,\n    join(serverBuildPath, PAGES_MANIFEST),\n    dir\n  ) as PagesManifest;\n\n  try {\n    page = denormalizePagePath(normalizePagePath(page));\n  } catch (err) {\n    console.error(err);\n    throw new PageNotFoundError(page);\n  }\n\n  const checkManifest = (manifest: PagesManifest) => {\n    let curPath = manifest[page];\n\n    if (!manifest[curPath] && locales) {\n      const manifestNoLocales: typeof pagesManifest = {};\n\n      for (const key of Object.keys(manifest)) {\n        manifestNoLocales[normalizeLocalePath(key, locales).pathname] =\n          pagesManifest[key];\n      }\n      curPath = manifestNoLocales[page];\n    }\n    return curPath;\n  }\n  let pagePath: string | undefined;\n\n  if (rootPathsManifest) {\n    pagePath = checkManifest(rootPathsManifest);\n  }\n\n  if (!pagePath) {\n    pagePath = checkManifest(pagesManifest);\n  }\n\n  if (!pagePath) {\n    throw new PageNotFoundError(page);\n  }\n  return join(serverBuildPath, pagePath);\n}\n\n/**\n * Loads the string or module that corresponds to a page.\n * (An adaptation for Compute of function in Next.js of the same name,\n * found at next/server/require.ts)\n */\nexport async function requirePage(\n  assets: Assets,\n  page: string,\n  dir: string,\n  distDir: string,\n  serverless: boolean,\n  appDirEnabled?: boolean\n): Promise<any> {\n  const pagePath = getPagePath(\n    assets,\n    page,\n    dir,\n    distDir,\n    serverless,\n    false,\n    undefined,\n    appDirEnabled\n  );\n  if (pagePath.endsWith('.html')) {\n    try {\n      return readAssetFileAsString(assets, pagePath, dir);\n    } catch(err) {\n      throw new MissingStaticPage(page, err.message);\n    }\n  }\n  return readAssetModule(assets, pagePath, dir);\n}\n\n/**\n * Load the font manifest.\n * (An adaptation for Compute of function in Next.js of the same name,\n * found at next/server/require.ts)\n */\nexport function requireFontManifest(\n  assets: Assets,\n  distDir: string,\n  dir: string,\n  serverless: boolean,\n) {\n  const serverBuildPath = join(\n    distDir,\n    serverless ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n  );\n  return readAssetManifest(\n    assets,\n    join(serverBuildPath, FONT_MANIFEST),\n    dir,\n  );\n}\n\n/* ---- */\n\nexport function assetDirectoryExists(\n  assets: Assets,\n  path: string,\n  dir: string,\n): boolean {\n  const relativePath = relative(dir, path);\n  return Object.keys(assets).some(key => key.startsWith('/' + relativePath + '/'));\n}\n\nexport function assetDirectory(\n  assets: Assets,\n  path: string,\n  dir: string,\n): string[] {\n  const relativePath = relative(dir, path);\n  return Object.keys(assets)\n    .filter(key => key.startsWith('/' + relativePath + '/'));\n}\n\nexport function assetFileExists(\n  assets: Assets,\n  path: string,\n  dir: string\n) {\n  const relativePath = relative(dir, path);\n  return '/' + relativePath in assets;\n}\n\nexport function readAssetFile(\n  assets: Assets,\n  path: string,\n  dir: string,\n) {\n  const relativePath = relative(dir, path);\n  const file = assets['/' + relativePath];\n  return file.content;\n}\n\nexport function readAssetFileAsString(\n  assets: Assets,\n  path: string,\n  dir: string,\n) {\n  let content = readAssetFile(\n    assets,\n    path,\n    dir\n  );\n  if(typeof content !== 'string') {\n    content = content.toString('utf8');\n  }\n  return content;\n}\n\nexport function getAssetContentType(\n  assets: Assets,\n  path: string,\n  dir: string,\n) {\n  const relativePath = relative(dir, path);\n  const file = assets['/' + relativePath];\n  return file.contentType;\n}\n\nexport function readAssetManifest(\n  assets: Assets,\n  path: string,\n  dir: string,\n) {\n  let content = readAssetFileAsString(assets, path, dir);\n  return JSON.parse(content);\n}\n\nexport function readAssetModule(\n  assets: Assets,\n  path: string,\n  dir: string,\n) {\n  const relativePath = relative(dir, path);\n  const file = assets['/' + relativePath];\n  return file.module;\n}\n"]}