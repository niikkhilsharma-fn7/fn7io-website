{"version":3,"file":"compute-js.js","sourceRoot":"","sources":["../../../src/server/compute-js.ts"],"names":[],"mappings":";AAAA;;;GAGG;;;AAUH,SAAS,eAAe,CAAC,QAAkB,EAAE,GAAW;IACtD,KAAK,MAAM,CAAC,WAAW,EAAE,OAAO,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE;QAC7D,IAAI,UAAU,GAAG,OAAO,OAAO,KAAK,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC;QACrE,IAAG,CAAC,UAAU,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;YAC5B,UAAU,IAAI,GAAG,CAAC;SACnB;QACD,IAAG,GAAG,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE;YAC7B,OAAO;gBACL,IAAI,EAAE,WAAW;gBACjB,GAAG,EAAE,UAAU;gBACf,MAAM,EAAE,GAAG,GAAG,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,MAAM,CAAC;aAC3C,CAAC;SACH;KACF;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAgB,cAAc,CAAC,QAA8B,EAAE,GAAW;IACxE,IAAG,QAAQ,IAAI,IAAI,EAAE;QACnB,OAAO,IAAI,CAAC;KACb;IAED,IAAI,WAAW,CAAC;IAEhB,MAAM,MAAM,GAAG,IAAI,GAAG,CAAC,GAAG,CAAC,CAAC;IAC5B,IAAG,MAAM,CAAC,IAAI,KAAK,EAAE,EAAE;QACrB,iDAAiD;QACjD,IAAI,MAAM,CAAC,QAAQ,KAAK,QAAQ,EAAE;YAChC,MAAM,CAAC,IAAI,GAAG,KAAK,CAAC;SACrB;aAAM;YACL,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC;SACpB;QACD,WAAW,GAAG,eAAe,CAAC,QAAQ,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;KACzD;IACD,IAAG,WAAW,IAAI,IAAI,EAAE;QACtB,WAAW,GAAG,eAAe,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;KAC9C;IAED,OAAO,WAAW,CAAC;AACrB,CAAC;AAtBD,wCAsBC","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n */\n\nimport type { Backends } from './common';\n\nexport type BackendInfo = {\n  name: string,\n  url: string,\n  target: string,\n};\n\nfunction findBackendInfo(backends: Backends, url: string): BackendInfo | null {\n  for (const [backendName, backend] of Object.entries(backends)) {\n    let backendUrl = typeof backend === 'string' ? backend : backend.url;\n    if(!backendUrl.endsWith('/')) {\n      backendUrl += '/';\n    }\n    if(url.startsWith(backendUrl)) {\n      return {\n        name: backendName,\n        url: backendUrl,\n        target: '/' + url.slice(backendUrl.length),\n      };\n    }\n  }\n  return null;\n}\n\nexport function getBackendInfo(backends: Backends | undefined, url: string) {\n  if(backends == null) {\n    return null;\n  }\n\n  let backendName;\n\n  const urlObj = new URL(url);\n  if(urlObj.port === '') {\n    // If port is not specified, try the default port\n    if (urlObj.protocol === 'https:') {\n      urlObj.port = '443';\n    } else {\n      urlObj.port = '80';\n    }\n    backendName = findBackendInfo(backends, String(urlObj));\n  }\n  if(backendName == null) {\n    backendName = findBackendInfo(backends, url);\n  }\n\n  return backendName;\n}\n"]}