{"version":3,"file":"serve-static.js","sourceRoot":"","sources":["../../../src/server/serve-static.ts"],"names":[],"mappings":";AAAA;;;GAGG;;;AAKH,uCAA+D;AAG/D;;;;GAIG;AACI,KAAK,UAAU,WAAW,CAC/B,MAAc,EACd,GAAyB,EACzB,GAA0B,EAC1B,IAAY,EACZ,GAAW;IAGX,MAAM,WAAW,GAAG,kBAAkB,CAAC,IAAI,CAAC,CAAC;IAC7C,MAAM,KAAK,GAAG,IAAA,uBAAa,EAAC,MAAM,EAAE,WAAW,EAAE,GAAG,CAAC,CAAC;IAEtD,MAAM,eAAe,GAAG,IAAI,OAAO,EAAE,CAAC;IAEtC,mEAAmE;IACnE,2DAA2D;IAC3D,MAAM,OAAO,GAAG,GAAG,CAAC,gBAAkC,CAAC;IACvD,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,EAAE,CAAC,EAAE;QAC/D,IAAG,KAAK,IAAI,IAAI,EAAE;YAChB,SAAS;SACV;QACD,IAAG,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;YACvB,KAAK,MAAM,KAAK,IAAI,KAAK,EAAE;gBACzB,eAAe,CAAC,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;aACpC;SACF;aAAM;YACL,eAAe,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;SAC5C;KACF;IAED,IAAG,CAAC,eAAe,CAAC,GAAG,CAAC,cAAc,CAAC,EAAE;QACvC,eAAe,CAAC,MAAM,CAAC,cAAc,EACnC,IAAA,6BAAmB,EAAC,MAAM,EAAE,WAAW,EAAE,GAAG,CAAC,CAC9C,CAAC;KACH;IAED,GAAG,CAAC,gBAAgB,GAAG,IAAI,QAAQ,CAAC,KAAK,EAAE;QACzC,MAAM,EAAE,GAAG;QACX,UAAU,EAAE,IAAI;QAChB,OAAO,EAAE,eAAe;KACzB,CAAC,CAAC;AACL,CAAC;AAxCD,kCAwCC","sourcesContent":["/*\n * Copyright Fastly, Inc.\n * Licensed under the MIT license. See LICENSE file for details.\n */\n\nimport type { ServerResponse } from 'http';\n\nimport { Assets } from './common';\nimport { getAssetContentType, readAssetFile } from './require';\nimport { ComputeJsNextRequest, ComputeJsNextResponse } from \"./base-http/compute-js\";\n\n/**\n * Serves the contents of a file at a path.\n * (A reimplementation for Compute of function in Next.js of the same name,\n * found at next/server/serve-static.ts)\n */\nexport async function serveStatic(\n  assets: Assets,\n  req: ComputeJsNextRequest,\n  res: ComputeJsNextResponse,\n  path: string,\n  dir: string,\n): Promise<void> {\n\n  const decodedPath = decodeURIComponent(path);\n  const asset = readAssetFile(assets, decodedPath, dir);\n\n  const outgoingHeaders = new Headers();\n\n  // Copy all the headers that have already been set on this response\n  // for example those set by setImmutableAssetCacheControl()\n  const nodeRes = res.originalResponse as ServerResponse;\n  for (const [key, value] of Object.entries(nodeRes.getHeaders())) {\n    if(value == null) {\n      continue;\n    }\n    if(Array.isArray(value)) {\n      for (const entry of value) {\n        outgoingHeaders.append(key, entry);\n      }\n    } else {\n      outgoingHeaders.append(key, String(value));\n    }\n  }\n\n  if(!outgoingHeaders.has('Content-Type')) {\n    outgoingHeaders.append('Content-Type',\n      getAssetContentType(assets, decodedPath, dir)\n    );\n  }\n\n  res.overrideResponse = new Response(asset, {\n    status: 200,\n    statusText: 'OK',\n    headers: outgoingHeaders,\n  });\n}\n"]}